<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PlantUML Editor</title>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        #header {
            background-color: #f1f1f1;
            padding: 10px;
            text-align: center;
            font-weight: bold;
        }

        #footer {
            padding: 10px;
        }

        #container {
            display: flex;
            flex: 1;
            width: 100%;
            overflow: hidden;
        }

        #editor {
            flex-grow: 0;
            flex-shrink: 0;
            width: calc(50% - 160px);
            min-width: 200px;
        }

        #resizer {
            width: 5px;
            background-color: #ccc;
            cursor: col-resize;
        }

        #image-container {
            flex-grow: 100;
            flex-shrink: 100;
            padding: 10px;
            overflow: auto;
        }

        #cola, #colb {
            flex-grow: 0;
            flex-shrink: 1;
        }

        #image-container img {
            max-width: 100%;
            height: auto;
        }
    </style>

    <style>
        table {
            width: 100%;
            margin: 1px auto;
            border-collapse: collapse;
            border: 1px solid #ddd;
            border-radius: 5px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        th, td {
            padding: 1px 5px;
            text-align: left;
            border-bottom: 1px solid #ddd;
            cursor: pointer;
        }
        tbody tr:hover {
            background-color: #f1f1f1;
        }
        table button {
            padding: 1px;
            background-color: #f6f8fa; /* Lighter grey */
            color: #24292e; /* Dark text color */
            border: 1px solid #d1d5da; /* Light grey border */
            border-radius: 6px;
            cursor: pointer;
            margin: 0;
        }
        table button:hover {
            background-color: #e1e4e8; /* Slightly darker on hover */
        }
    </style>



    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.14/ace.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.14/ext-language_tools.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.0.4/pako.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/brython@3.12.2/brython.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.3/css/jquery.dataTables.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-fork-ribbon-css/0.2.3/gh-fork-ribbon.min.css" />
</head>
<body onload="brython()">

<a class="github-fork-ribbon" href="https://github.com/plantuml/brython-editor" data-ribbon="Fork me on GitHub" title="Fork me on GitHub">Fork me on GitHub</a>

<div id="header"><a href=https://plantuml.com>PlantUML</a> Web Editor</div>

<div id="container">
    <div id="cola">
    </div>
    <div id="editor"></div>
    <div id="resizer"></div>
    <div id="image-container">
        <img id="diagram-image" src="https://www.plantuml.com/plantuml/png/SoWkIImgAStDuNBCoKnELT2rKt3AJrAmKiX8pSd9vt98pKi1IG80" alt="PlantUML Diagram">
    </div>
    <div id="colb">
    </div>
</div>

<style>
    /* Style for the text area */
    #encoded-input {
        width: 100%;
        padding: 2px;
        font-size: 14px;
        border: 1px solid #ccc;
        border-radius: 4px;
        box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    /* Apply the flex layout to the container */
    .tooltip-container {
        display: flex;
        align-items: center; /* Vertically align the elements */
        position: relative;
    }

    /* Style for the input */
    #encoded-input {
        flex-grow: 1; /* Allow the input to take up as much space as possible */
        margin-right: 10px; /* Space between the encoded input and the Decode button */
    }

    /* Style for the Decode button */
    .decode-btn {
        padding: 4px 8px;
        background-color: #f6f8fa;
        color: #24292e;
        border: 1px solid #d1d5da;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        white-space: nowrap;
    }

    .decode-btn:hover {
        background-color: #e1e4e8;
    }

    /* Style for the copy button */
    .btn {
        padding: 4px 8px;
        background-color: #f6f8fa; /* Lighter grey */
        color: #24292e; /* Dark text color */
        border: 1px solid #d1d5da; /* Light grey border */
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        margin: 10px 0; /* Adds some spacing above and below */
    }

    .btn:hover {
        background-color: #e1e4e8; /* Slightly darker on hover */
    }

    /* Style for the delete button */
    .delete-btn {
        padding: 2px 8px;
        background-color: #f6f8fa; /* Lighter grey */
        color: #24292e; /* Dark text color */
        border: 1px solid #d1d5da; /* Light grey border */
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        margin: 2px 0; /* Adds some spacing above and below */
    }

    .delete-btn:hover {
        background-color: #e1e4e8; /* Slightly darker on hover */
    }

</style>

<div id="footer">
    <!-- Button to copy the text with an icon -->
    <button class="btn" id="copy-btn">
        <i class="fas fa-copy"></i> Copy
    </button>

    <!-- Button to paste the text with an icon -->
    <button class="btn" id="paste-btn">
        <i class="fas fa-paste"></i> Paste
    </button>

    <!-- Button to save with an icon -->
    <button class="btn" id="save-btn">
        <i class="fas fa-save"></i> Save
    </button>

    <!-- Button to load with an icon -->
    <button class="btn" id="load-btn">
        <i class="fas fa-folder-open"></i> List
    </button>

    <div class="tooltip-container">
        <input id="encoded-input" type="text" value="SoWkIImgAStDuNBCoKnELT2rKt3AJ-9oICrB0Ga20000">

        <button class="decode-btn" id="decode-btn">
            <i class="fas fa-unlock-alt"></i> Decode
        </button>
    </div>
</div>


<script>
    ace.define("ace/mode/plantuml", ["require", "exports", "ace/lib/oop", "ace/mode/text", "ace/mode/text_highlight_rules"], function(acequire, exports) {
        var oop = acequire("ace/lib/oop");
        var TextMode = acequire("ace/mode/text").Mode;
        var TextHighlightRules = acequire("ace/mode/text_highlight_rules").TextHighlightRules;

        function PlantUMLHighlightRules() {
            this.$rules = {
                "start": [
                    { token: "comment", regex: "^\\s*'.*" },
                    { token: "comment", regex: "/'", next: "comment" },
                    { token: "keyword", regex: "@startuml|@enduml|actor|participant|usecase|->|-->|:|note|as|class|interface|abstract|enum" },
                    { token: "string", regex: '".*?"' }
                ],
                "comment": [
                    { token: "comment", regex: ".*?'/", next: "start" },
                    { token: "comment", regex: ".+" }
                ]
            };
        }
        oop.inherits(PlantUMLHighlightRules, TextHighlightRules);

        function PlantUMLMode() {
            this.HighlightRules = PlantUMLHighlightRules;
            this.blockComment = { start: "/'", end: "'/" };
        }
        oop.inherits(PlantUMLMode, TextMode);

        exports.Mode = PlantUMLMode;
    });
</script>

    
<script type="text/python">
    from browser import document, window, html

    def encode6bit(b):
        if b < 10:
            return chr(48 + b)
        b -= 10
        if b < 26:
            return chr(65 + b)
        b -= 26
        if b < 26:
            return chr(97 + b)
        b -= 26
        if b == 0:
            return '-'
        if b == 1:
            return '_'
        return '?'

    def append3bytes(b1, b2, b3):
        c1 = b1 >> 2
        c2 = ((b1 & 0x3) << 4) | (b2 >> 4)
        c3 = ((b2 & 0xF) << 2) | (b3 >> 6)
        c4 = b3 & 0x3F
        return encode6bit(c1 & 0x3F) + encode6bit(c2 & 0x3F) + encode6bit(c3 & 0x3F) + encode6bit(c4 & 0x3F)

    def encode64(data):
        r = ""
        i = 0
        while i < len(data):
            if i + 2 == len(data):
                r += append3bytes(data[i], data[i + 1], 0)
            elif i + 1 == len(data):
                r += append3bytes(data[i], 0, 0)
            else:
                r += append3bytes(data[i], data[i + 1], data[i + 2])
            i += 3
        return r


    def decode64(data):
        r = ""
        i = 0
        while i < len(data):
            b1 = decode6bit(data[i])
            b2 = decode6bit(data[i + 1])
            b3 = decode6bit(data[i + 2])
            b4 = decode6bit(data[i + 3])

            c1 = (b1 << 2) | (b2 >> 4)
            c2 = ((b2 & 0xF) << 4) | (b3 >> 2)
            c3 = ((b3 & 0x3) << 6) | b4

            r += chr(c1)
            if b3 != 64:
                r += chr(c2)
            if b4 != 64:
                r += chr(c3)

            i += 4

        return r

    def decode6bit(c):
        if '0' <= c <= '9':
            return ord(c) - 48
        if 'A' <= c <= 'Z':
            return ord(c) - 65 + 10
        if 'a' <= c <= 'z':
            return ord(c) - 97 + 36
        if c == '-':
            return 62
        if c == '_':
            return 63
        return 64  # Padding character, usually absent

    def compress_and_encode(data):
        utf8_encoder = window.TextEncoder.new()
        byte_array = utf8_encoder.encode(data)
        compressed = window.pako.deflateRaw(byte_array)

        # Base64 encoding must be done on binary bytes
        compressed_list = [compressed[i] for i in range(compressed.length)]

        # Base64 encoding from the byte array
        return encode64(compressed_list)


    def decompress_and_decode(data):
        decoded_base64 = decode64(data)

        # Convert the decoded string into a byte array
        byteArray = window.Uint8Array.new([ord(c) for c in decoded_base64])
        inflated = window.pako.inflateRaw(byteArray)

        # Proper use of TextDecoder with "new"
        text_decoder = window.TextDecoder.new("utf-8")
        return text_decoder.decode(inflated)


    # Function to retrieve URL parameters
    def get_url_param(param_name):
        url_params = window.location.search
        params = dict(p.split('=') for p in url_params[1:].split('&') if '=' in p)
        return params.get(param_name, None)

    # Retrieve the value of the 'uml' parameter
    uml_value = get_url_param('uml')

    # Display or use the retrieved value
    if uml_value:
        print(f"'uml' parameter found: {uml_value}")


    # Text for the PlantUML diagram example
    plantUMLDiagramText = """@startuml
    Alice -> Bob : hello
    @enduml
    """

    # Using custom mode in the ACE editor
    editor = window.ace.edit("editor")
    editor.session.setMode("ace/mode/plantuml")
    editor.setTheme("ace/theme/github")  # Using the GitHub theme

    # Set the initial content
    editor.setValue(plantUMLDiagramText, 1)   # The second argument places the cursor at the end of the content

    # Optional settings
    editor.setOptions({
        "fontSize": "10pt",
        "showLineNumbers": True,
        "tabSize": 4
    })

    # Variable to store the timer ID
    timeout_id = None

    def editor_change(*args):
        global timeout_id
        # Retrieve the value from the editor
        v = editor.getValue()
        if len(v)>0:
            encoded = compress_and_encode(v)
            print(f"editor_change {len(v)=} {encoded=}")
            document["encoded-input"].value = encoded
            if timeout_id:
                window.clearTimeout(timeout_id)

            timeout_id = window.setTimeout(lambda: image_update(encoded), 1500)

    def image_update(encoded):
        document["diagram-image"].attrs['src'] = f"https://www.plantuml.com/plantuml/png/{encoded}"

    # Bind the change event to the editor_change function
    editor.session.on('change', editor_change)

    # Resize logic
    resizer = document["resizer"]
    editorDiv = document["editor"]
    imageContainer = document["image-container"]

    def resize(event):
        containerRect = document["container"].getBoundingClientRect()
        colaRect = document["cola"].getBoundingClientRect()

        newWidth = event.clientX - containerRect.left - colaRect.width

        editorDiv.style.width = f'{newWidth}px'

    def stopResize(event):
        document.unbind('mousemove', resize)
        document.unbind('mouseup', stopResize)

    def startResize(event):
        event.preventDefault()
        document.bind('mousemove', resize)
        document.bind('mouseup', stopResize)

    resizer.bind('mousedown', startResize)


    # Function that will be called when the encoded value changes
    def click_on_decode(event):
        input_value = document["encoded-input"].value
        # Check if a slash is present and retrieve the text after the last slash
        if '/' in input_value:
            input_value = input_value.rpartition('/')[-1]  # Take the part after the last slash

        print(f"on_encoded_input_change {input_value=}")
        uml = decompress_and_decode(input_value)
        print(f"on_encoded_input_change {uml=}")
        editor.setValue(uml)


    # Bind the function to the 'click' event of the "Decode" button
    document["decode-btn"].bind("click", click_on_decode)

    # Function to copy the diagram text to the clipboard
    def copy_to_clipboard(event):
        editor_value = window.ace.edit("editor").getValue()  # Get the text from the editor
        window.navigator.clipboard.writeText(editor_value)  # Copy to the clipboard

    # Bind the copy_to_clipboard function to the "Copy" button
    document["copy-btn"].bind("click", copy_to_clipboard)


    # Function to paste the clipboard text into the editor
    def paste_from_clipboard(event):
        # Use the clipboard API to read the text
        window.navigator.clipboard.readText().then(paste_text)

    # Function that pastes the retrieved text into the editor
    def paste_text(text):
        editor = window.ace.edit("editor")  # Retrieve the ACE editor
        editor.setValue(text, 1)  # Overwrite all content with the clipboard text, and place the cursor at the end

    # Bind the paste_from_clipboard function to the "Paste" button
    document["paste-btn"].bind("click", paste_from_clipboard)

    def save_file(event):
        # Generate an encoded date in the format YYYY_MM_DD__HH_MM_SS with JavaScript
        current_time = window.Date.new().toISOString().replace(":", "_").replace("-", "_").split(".")[0].replace("T", "__")
        
        # Propose the encoded date as the default file name
        filename = window.prompt("This will be saved locally in your browser:", f"diagram_{current_time}")
        
        if filename:
            # Retrieve the content from the editor
            editor_value = window.ace.edit("editor").getValue()
            print(editor_value)
            # Save in LocalStorage with the key provided by the user
            window.localStorage.setItem("pl_" + filename, editor_value)
            
            # Confirmation of the save
            print(f"Content saved under the key : {filename}")

    # Bind the save_file function to the "Save" button
    document["save-btn"].bind("click", save_file)


    def load_file(event):
        # Retrieve all keys that start with "pl_"
        keys = [window.localStorage.key(i) for i in range(window.localStorage.length) if window.localStorage.key(i).startswith("pl_")]
        
        if not keys:
            window.alert("Nothing to reload.")
            return

        # Sort the keys alphabetically, including the "pl_" prefix
        keys.sort()  # Sort directly, including the 'pl_' prefix

        # Create a background div that covers the entire page
        back_div = document.createElement('div')
        back_div.id = "back-div"
        
        # CSS styles for the back_div
        back_div.style.position = "fixed"
        back_div.style.top = "0"
        back_div.style.left = "0"
        back_div.style.width = "100%"
        back_div.style.height = "100%"
        back_div.style.backgroundColor = "rgba(0, 0, 0, 0.5)"  # Transparent dark background
        back_div.style.zIndex = "999"  # Back div behind load_div

        # Function to close both divs when clicking on back_div
        def close_on_click(event):
            back_div.remove()
            load_div.remove()

        # Bind click event to back_div to close it when clicked
        back_div.bind("click", close_on_click)
                
        # Add the back_div to the document
        document.body <= back_div
    
        # Create a dynamic div to display the key options
        load_div = document.createElement('div')
        load_div.id = "load-div"
        
        # CSS styles to center the div
        load_div.style.position = "absolute"
        load_div.style.top = "50%"
        load_div.style.left = "50%"
        load_div.style.transform = "translate(-50%, -50%)"
        load_div.style.backgroundColor = "white"
        load_div.style.border = "1px solid #ccc"
        load_div.style.padding = "20px"  # Increase padding for a larger look
        load_div.style.boxShadow = "0 4px 8px rgba(0, 0, 0, 0.1)"
        load_div.style.width = "70%"  # Increase width of the div
        load_div.style.height = "60%"  # Increase height of the div
        load_div.style.overflowY = "auto"  # Add scroll if content overflows vertically
        load_div.style.zIndex = "1000"  # Ensure the div is in the foreground


        # Insert table instead of buttons
        load_div.innerHTML = "<strong>Available Files</strong><br><br>"
        
        table = html.TABLE()
        table_body = html.TBODY()

        # Add rows for each file
        for i, key in enumerate(keys):
            row = html.TR()

            # Delete button column
            delete_button = html.BUTTON(Class="delete-btn")
            delete_button <= html.I(Class="fas fa-trash")  # Add Font Awesome trash icon inside the button
            delete_button.bind("click", lambda ev, k=key: delete_file(k))
            delete_col = html.TD(delete_button)
            delete_col.style.width = "1%"  # Set a small width for the delete column
            
            # File name column
            file_col = html.TD()
            file_name_span = html.SPAN(key[3:])
            file_col.bind("click", lambda ev, k=key: load_key(k))  # Bind click event to the span
            file_col <= file_name_span  # Add span to the file_col

            # Append columns to row
            row <= delete_col
            row <= file_col

            # Append row to the table body
            table_body <= row

        # Append table body to the table
        table <= table_body

        # Add table to load_div
        load_div <= table
        
        # Add the div to the document
        document.body <= load_div

    def delete_file(chosen_key):
        # Delete the file from LocalStorage
        window.localStorage.removeItem(chosen_key)
        
        # Reload the div to reflect the changes
        document["load-div"].remove()
        load_file(None)


    def load_key(chosen_key):
        # Load the value associated with the chosen key
        editor_value = window.localStorage.getItem(chosen_key)
        
        # Reload the value into the editor
        window.ace.edit("editor").setValue(editor_value)
        print(f"Content loaded from the key : {chosen_key}")
        
        # Remove the div after loading the data
        document["load-div"].remove()
        document["back-div"].remove()

    # Bind the load_file function to the "Load" button
    document["load-btn"].bind("click", load_file)

</script>

</body>
</html>
